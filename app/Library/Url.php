<?php
/**
 * Created by PhpStorm.
 * User: fesiong
 * Date: 2016/11/15
 * Time: 下午8:06
 */

namespace Fesion\Library;

use Fesion\Models\Site;
use Phalcon\Http\Request;

class Url extends \Phalcon\Mvc\Url
{
    public function get($uri = null, $args = null, $local = null, $baseUri = null)
    {
        /** @var Request $request */
        $request = $this->getDI()->getShared('request');
        $commonSite = Site::findFirst([
            "directory = 'common'",
            "cache" => [
                "key" => "site-common"
            ]
        ]);
        $adminHost = $this->getDI()->getShared('config')->get('site')->adminHost;
        $host = $request->getHttpHost();
        if($host != $adminHost){
            list($type, $id) = explode('/', $uri);
            if(!$baseUri) {
                if (!in_array($type, [
                    'topic',
                //    'blog',
                    'course',
                    'lesson',
                    'ajax'
                ])
                ) {
                    $baseUri = $request->getScheme() . "://" . $commonSite->getDomain() . '/';
                }
                if ($site = Site::findFirst([
                    "directory = '{$type}'",
                    "cache" => [
                        "key" => "site-{$type}"
                    ]
                ])
                ) {
                    $uri = substr($uri, strlen($type) + 1);
                    $baseUri = $request->getScheme() . "://" . $site->getDomain() . '/';
                }
            }
        }

        return parent::get($uri, $args, $local, $baseUri); // TODO: Change the autogenerated stub
    }
}